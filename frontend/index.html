<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Manager â€” Universe Soft Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 0.25s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

    /* Skeleton shimmer */
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 6px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH SECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authSection" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-6 text-white">
      <h1 class="text-2xl font-bold">ğŸ“‹ Task Manager</h1>
      <p class="text-indigo-200 text-sm mt-1">Universe Soft Tech</p>
    </div>
    <div class="flex border-b border-gray-200">
      <button onclick="switchTab('login')" id="loginTab"
        class="flex-1 py-3 text-sm font-semibold text-indigo-600 border-b-2 border-indigo-600 transition-all">Sign In</button>
      <button onclick="switchTab('register')" id="registerTab"
        class="flex-1 py-3 text-sm font-semibold text-gray-400 border-b-2 border-transparent transition-all hover:text-indigo-600">Register</button>
    </div>
    <div class="p-8">
      <!-- Login -->
      <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input id="loginUsername" type="text" required placeholder="Enter username"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input id="loginPassword" type="password" required placeholder="Enter password"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
        </div>
        <div id="loginError" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-lg"></div>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 rounded-lg transition-colors text-sm">Sign In</button>
      </form>
      <!-- Register -->
      <form id="registerForm" onsubmit="handleRegister(event)" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
            <input id="regFirstName" type="text" placeholder="John"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
            <input id="regLastName" type="text" placeholder="Doe"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input id="regUsername" type="text" required placeholder="Choose a username"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input id="regEmail" type="text" required placeholder="you@example.com"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input id="regPassword" type="password" required placeholder="Min 8 characters"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
          <input id="regPassword2" type="password" required placeholder="Repeat password"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
        </div>
        <div id="registerError" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-lg"></div>
        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 rounded-lg transition-colors text-sm">Create Account</button>
      </form>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard" class="hidden min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ“‹</span>
        <span class="font-bold text-gray-800">Task Manager</span>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-sm text-gray-600">Hello, <strong id="navUsername" class="text-indigo-600"></strong></span>
        <button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-800 font-medium transition-colors">Sign Out</button>
      </div>
    </div>
  </nav>

  <main class="flex-1 max-w-6xl mx-auto w-full px-4 sm:px-6 py-8">
    <!-- Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
        <div id="statTotal" class="text-2xl font-bold text-gray-800">â€”</div>
        <div class="text-xs text-gray-500 mt-1">Loaded</div>
      </div>
      <div class="bg-yellow-50 rounded-xl p-4 shadow-sm border border-yellow-100 text-center">
        <div id="statPending" class="text-2xl font-bold text-yellow-600">â€”</div>
        <div class="text-xs text-gray-500 mt-1">Pending</div>
      </div>
      <div class="bg-blue-50 rounded-xl p-4 shadow-sm border border-blue-100 text-center">
        <div id="statInProgress" class="text-2xl font-bold text-blue-600">â€”</div>
        <div class="text-xs text-gray-500 mt-1">In Progress</div>
      </div>
      <div class="bg-green-50 rounded-xl p-4 shadow-sm border border-green-100 text-center">
        <div id="statCompleted" class="text-2xl font-bold text-green-600">â€”</div>
        <div class="text-xs text-gray-500 mt-1">Completed</div>
      </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Form Panel -->
      <div class="lg:w-80 flex-shrink-0">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-24">
          <h2 id="formTitle" class="text-base font-semibold text-gray-800 mb-4">â• New Task</h2>
          <form onsubmit="handleSaveTask(event)" class="space-y-4">
            <input type="hidden" id="editTaskId" />
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Title *</label>
              <input id="taskTitle" type="text" required placeholder="Task title"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Description</label>
              <textarea id="taskDesc" rows="3" placeholder="Optional details..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm resize-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Priority</label>
                <select id="taskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Status</label>
                <select id="taskStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                  <option value="pending" selected>Pending</option>
                  <option value="in_progress">In Progress</option>
                  <option value="completed">Completed</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Due Date</label>
              <input id="taskDueDate" type="date"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
            </div>
            <div id="taskFormError" class="hidden text-red-600 text-xs bg-red-50 p-2 rounded-lg"></div>
            <div class="flex gap-2">
              <button type="submit" id="saveBtn"
                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition-colors text-sm">Save Task</button>
              <button type="button" onclick="cancelEdit()" id="cancelBtn"
                class="hidden px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition-colors">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Task List Panel -->
      <div class="flex-1 min-w-0">
        <!-- Filter Bar -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4">
          <div class="flex flex-wrap gap-3 items-center">
            <input id="searchInput" type="text" placeholder="ğŸ” Search tasks..."
              oninput="debouncedFetch()"
              class="flex-1 min-w-48 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
            <select id="filterStatus" onchange="resetAndFetch()"
              class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
            <select id="filterPriority" onchange="resetAndFetch()"
              class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
              <option value="">All Priorities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select id="filterOrdering" onchange="resetAndFetch()"
              class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
              <option value="-created_at">Newest First</option>
              <option value="created_at">Oldest First</option>
              <option value="due_date">Due Date â†‘</option>
              <option value="-due_date">Due Date â†“</option>
              <option value="title">Title Aâ€“Z</option>
            </select>
          </div>
        </div>

        <!-- Task count indicator -->
        <div id="taskCountBar" class="hidden text-xs text-gray-400 mb-3 px-1">
          Showing <span id="loadedCount" class="font-semibold text-gray-600">0</span> tasks
          <span id="hasMoreIndicator" class="ml-2 text-indigo-400">â€” scroll for more</span>
        </div>

        <!-- Task Cards Container -->
        <div id="taskList" class="space-y-3"></div>

        <!-- Skeleton loaders (shown while first load) -->
        <div id="skeletonList" class="space-y-3">
          <div class="bg-white rounded-xl p-4 border border-gray-100" aria-hidden="true">
            <div class="skeleton h-4 w-3/4 mb-3"></div>
            <div class="flex gap-2"><div class="skeleton h-3 w-16"></div><div class="skeleton h-3 w-20"></div></div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-gray-100" aria-hidden="true">
            <div class="skeleton h-4 w-1/2 mb-3"></div>
            <div class="flex gap-2"><div class="skeleton h-3 w-16"></div><div class="skeleton h-3 w-20"></div></div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-gray-100" aria-hidden="true">
            <div class="skeleton h-4 w-2/3 mb-3"></div>
            <div class="flex gap-2"><div class="skeleton h-3 w-16"></div><div class="skeleton h-3 w-20"></div></div>
          </div>
        </div>

        <!-- Infinite scroll sentinel -->
        <div id="scrollSentinel" class="h-10 flex items-center justify-center mt-4">
          <div id="loadingMore" class="hidden text-sm text-gray-400 flex items-center gap-2">
            <svg class="animate-spin h-4 w-4 text-indigo-400" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
            </svg>
            Loading more tasks...
          </div>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="hidden text-center py-16 text-gray-400">
          <div class="text-5xl mb-3">ğŸ“­</div>
          <p class="font-medium">No tasks found</p>
          <p class="text-sm mt-1">Create your first task using the form!</p>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Task Detail Modal (shows description on click) -->
<div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 fade-in">
    <div class="flex justify-between items-start mb-4">
      <h3 id="modalTitle" class="text-lg font-bold text-gray-800 pr-4"></h3>
      <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl leading-none">âœ•</button>
    </div>
    <div id="modalBody" class="text-sm text-gray-600 space-y-2"></div>
    <div class="mt-5 flex gap-2 justify-end">
      <button onclick="editFromModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition-colors">Edit Task</button>
      <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition-colors">Close</button>
    </div>
  </div>
</div>

<script>
const API_BASE = '/api';
let accessToken = localStorage.getItem('access_token') || '';
let currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');

// Infinite scroll state
let nextCursor = null;
let isFetching = false;
let allLoadedTasks = [];
let modalTaskData = null;
const taskCache = new Map(); // id -> full lightweight task object for card edits

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authHeaders() {
  return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
}
function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.classList.remove('hidden');
}
function hideError(id) { document.getElementById(id).classList.add('hidden'); }

function priorityBadge(p) {
  const m = { high: 'bg-red-100 text-red-700', medium: 'bg-yellow-100 text-yellow-700', low: 'bg-green-100 text-green-700' };
  return `<span class="px-2 py-0.5 text-xs font-semibold rounded-full ${m[p]||''}">${p.charAt(0).toUpperCase()+p.slice(1)}</span>`;
}
function statusBadge(s) {
  const m = { pending: 'bg-gray-100 text-gray-700', in_progress: 'bg-blue-100 text-blue-700', completed: 'bg-green-100 text-green-700' };
  const label = s === 'in_progress' ? 'In Progress' : s.charAt(0).toUpperCase()+s.slice(1);
  return `<span class="px-2 py-0.5 text-xs font-semibold rounded-full ${m[s]||''}">${label}</span>`;
}
function escapeHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function updateStats() {
  document.getElementById('statTotal').textContent      = allLoadedTasks.length;
  document.getElementById('statPending').textContent    = allLoadedTasks.filter(t=>t.status==='pending').length;
  document.getElementById('statInProgress').textContent = allLoadedTasks.filter(t=>t.status==='in_progress').length;
  document.getElementById('statCompleted').textContent  = allLoadedTasks.filter(t=>t.status==='completed').length;
  document.getElementById('loadedCount').textContent    = allLoadedTasks.length;
  const hasMore = nextCursor !== null;
  document.getElementById('hasMoreIndicator').style.display = hasMore ? '' : 'none';
}

// â”€â”€â”€ AUTH TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
  document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
  const active   = 'flex-1 py-3 text-sm font-semibold text-indigo-600 border-b-2 border-indigo-600 transition-all';
  const inactive = 'flex-1 py-3 text-sm font-semibold text-gray-400 border-b-2 border-transparent transition-all hover:text-indigo-600';
  document.getElementById('loginTab').className    = tab==='login'    ? active : inactive;
  document.getElementById('registerTab').className = tab==='register' ? active : inactive;
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleLogin(e) {
  e.preventDefault(); hideError('loginError');
  try {
    const res  = await fetch(`${API_BASE}/auth/login/`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username:document.getElementById('loginUsername').value, password:document.getElementById('loginPassword').value }) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Invalid credentials');
    accessToken = data.access;
    localStorage.setItem('access_token', accessToken);
    localStorage.setItem('refresh_token', data.refresh);
    localStorage.setItem('current_user', JSON.stringify(data.user));
    currentUser = data.user;
    showDashboard();
  } catch(err) { showError('loginError', err.message); }
}

async function handleRegister(e) {
  e.preventDefault(); hideError('registerError');
  try {
    const res  = await fetch(`${API_BASE}/auth/register/`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username:document.getElementById('regUsername').value, email:document.getElementById('regEmail').value, first_name:document.getElementById('regFirstName').value, last_name:document.getElementById('regLastName').value, password:document.getElementById('regPassword').value, password2:document.getElementById('regPassword2').value }) });
    const data = await res.json();
    if (!res.ok) throw new Error(Object.values(data).flat().join(' '));
    accessToken = data.tokens.access;
    localStorage.setItem('access_token', accessToken);
    localStorage.setItem('refresh_token', data.tokens.refresh);
    localStorage.setItem('current_user', JSON.stringify(data.user));
    currentUser = data.user;
    showDashboard();
  } catch(err) { showError('registerError', err.message); }
}

async function handleLogout() {
  const refresh = localStorage.getItem('refresh_token');
  if (refresh) await fetch(`${API_BASE}/auth/logout/`, { method:'POST', headers:authHeaders(), body:JSON.stringify({refresh}) }).catch(()=>{});
  accessToken=''; currentUser=null;
  localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); localStorage.removeItem('current_user');
  showAuth();
}

function showDashboard() {
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('navUsername').textContent = currentUser?.username || 'User';
  resetAndFetch();
}
function showAuth() {
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('authSection').classList.remove('hidden');
}

// â”€â”€â”€ TASKS: FETCH (cursor-based infinite scroll) â”€â”€
function buildUrl(cursor = null) {
  const search   = document.getElementById('searchInput').value.trim();
  const status   = document.getElementById('filterStatus').value;
  const priority = document.getElementById('filterPriority').value;
  const ordering = document.getElementById('filterOrdering').value;
  let url = `${API_BASE}/tasks/?ordering=${ordering}`;
  if (search)   url += `&search=${encodeURIComponent(search)}`;
  if (status)   url += `&status=${status}`;
  if (priority) url += `&priority=${priority}`;
  if (cursor)   url += `&cursor=${encodeURIComponent(cursor)}`;
  return url;
}

// Reset list and load first page
function resetAndFetch() {
  allLoadedTasks = [];
  nextCursor = null;
  document.getElementById('taskList').innerHTML = '';
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('taskCountBar').classList.add('hidden');
  document.getElementById('skeletonList').classList.remove('hidden');
  fetchNextPage();
}

async function fetchNextPage() {
  if (isFetching) return;
  isFetching = true;

  // Show inline spinner (not skeleton) for subsequent pages
  if (allLoadedTasks.length > 0) {
    document.getElementById('loadingMore').classList.remove('hidden');
  }

  try {
    // Extract cursor token from full URL if needed
    let cursorToken = null;
    if (nextCursor) {
      try { cursorToken = new URL(nextCursor).searchParams.get('cursor'); } catch { cursorToken = nextCursor; }
    }

    const res  = await fetch(buildUrl(cursorToken), { headers: authHeaders() });
    if (res.status === 401) { handleLogout(); return; }
    const data = await res.json();

    const tasks = data.results || [];
    nextCursor  = data.next || null;

    // Hide skeletons on first load
    document.getElementById('skeletonList').classList.add('hidden');
    document.getElementById('loadingMore').classList.add('hidden');

    allLoadedTasks = [...allLoadedTasks, ...tasks];

    if (allLoadedTasks.length === 0) {
      document.getElementById('emptyState').classList.remove('hidden');
    } else {
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('taskCountBar').classList.remove('hidden');
      const fragment = document.createDocumentFragment();
      tasks.forEach(t => {
        taskCache.set(t.id, t);   // cache for safe card-level edit (no inline string escaping)
        const div = document.createElement('div');
        div.innerHTML = renderTask(t);
        fragment.appendChild(div.firstElementChild);
      });
      document.getElementById('taskList').appendChild(fragment);
    }

    updateStats();
  } catch(err) {
    document.getElementById('skeletonList').classList.add('hidden');
    document.getElementById('loadingMore').classList.add('hidden');
    console.error('Fetch error:', err);
  } finally {
    isFetching = false;
  }
}

// â”€â”€â”€ RENDER TASK CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTask(task) {
  const due       = task.due_date ? `<span class="text-xs text-gray-400">ğŸ“… ${task.due_date}</span>` : '';
  const isComplete = task.status === 'completed';
  return `
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 fade-in cursor-pointer hover:border-indigo-200 hover:shadow-md transition-all"
         onclick="openDetail(${task.id})">
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0 pointer-events-none">
          <h3 class="font-semibold text-gray-800 ${isComplete?'line-through text-gray-400':''} truncate">${escapeHtml(task.title)}</h3>
          <div class="flex flex-wrap items-center gap-2 mt-2">
            ${priorityBadge(task.priority)}
            ${statusBadge(task.status)}
            ${due}
          </div>
        </div>
        <div class="flex gap-1 flex-shrink-0" onclick="event.stopPropagation()">
          <button onclick="startEditById(${task.id}); event.stopPropagation();"
            class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Edit">âœï¸</button>
          <button onclick="deleteTask(${task.id},'${escapeHtml(task.title)}')"
            class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Delete">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`;
}

// â”€â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDetail(id) {
  document.getElementById('detailModal').classList.remove('hidden');
  document.getElementById('modalTitle').textContent = 'Loadingâ€¦';
  document.getElementById('modalBody').innerHTML    = '<div class="skeleton h-4 w-full mb-2"></div><div class="skeleton h-4 w-3/4"></div>';

  try {
    const res  = await fetch(`${API_BASE}/tasks/${id}/`, { headers: authHeaders() });
    const task = await res.json();
    modalTaskData = task;
    document.getElementById('modalTitle').textContent = task.title;
    document.getElementById('modalBody').innerHTML = `
      <div class="flex gap-2 flex-wrap mb-3">${priorityBadge(task.priority)} ${statusBadge(task.status)}</div>
      ${task.due_date ? `<p class="text-gray-500">ğŸ“… Due: <strong>${task.due_date}</strong></p>` : ''}
      ${task.description ? `<p class="text-gray-700 mt-2 whitespace-pre-wrap">${escapeHtml(task.description)}</p>` : '<p class="text-gray-400 italic">No description</p>'}
      <p class="text-xs text-gray-400 mt-3">Created: ${new Date(task.created_at).toLocaleString()}</p>`;
  } catch {
    document.getElementById('modalBody').innerHTML = '<p class="text-red-500">Failed to load task details.</p>';
  }
}
function closeModal() {
  document.getElementById('detailModal').classList.add('hidden');
  modalTaskData = null;
}
function editFromModal() {
  const task = modalTaskData;   // snapshot BEFORE closeModal() nulls it
  closeModal();                 // safe now â€” uses snapshot below
  if (task) startEdit(task);
}

// â”€â”€â”€ CREATE / UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleSaveTask(e) {
  e.preventDefault(); hideError('taskFormError');
  const id   = document.getElementById('editTaskId').value;
  const body = {
    title:       document.getElementById('taskTitle').value,
    description: document.getElementById('taskDesc').value,
    priority:    document.getElementById('taskPriority').value,
    status:      document.getElementById('taskStatus').value,
    due_date:    document.getElementById('taskDueDate').value || null,
  };
  const url    = id ? `${API_BASE}/tasks/${id}/` : `${API_BASE}/tasks/`;
  const method = id ? 'PUT' : 'POST';
  try {
    const res  = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) throw new Error(Object.values(data).flat().join(' '));
    cancelEdit();
    resetAndFetch();
  } catch(err) { showError('taskFormError', err.message); }
}

function startEditById(id) {
  // Fetch full task from API so description is included (list response omits it)
  fetch(`${API_BASE}/tasks/${id}/`, { headers: authHeaders() })
    .then(r => r.json())
    .then(task => startEdit(task))
    .catch(() => {
      // Fallback to cached lightweight data if fetch fails
      const cached = taskCache.get(id);
      if (cached) startEdit(cached);
    });
}

function startEdit(task) {
  document.getElementById('editTaskId').value   = task.id;
  document.getElementById('taskTitle').value    = task.title || '';
  document.getElementById('taskDesc').value     = task.description || '';
  document.getElementById('taskPriority').value = task.priority || 'medium';
  document.getElementById('taskStatus').value   = task.status || 'pending';
  document.getElementById('taskDueDate').value  = task.due_date || '';
  document.getElementById('formTitle').textContent = 'âœï¸ Edit Task';
  document.getElementById('saveBtn').textContent   = 'Update Task';
  document.getElementById('cancelBtn').classList.remove('hidden');
  document.getElementById('taskTitle').focus();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
  document.getElementById('editTaskId').value   = '';
  document.getElementById('taskTitle').value    = '';
  document.getElementById('taskDesc').value     = '';
  document.getElementById('taskPriority').value = 'medium';
  document.getElementById('taskStatus').value   = 'pending';
  document.getElementById('taskDueDate').value  = '';
  document.getElementById('formTitle').textContent = 'â• New Task';
  document.getElementById('saveBtn').textContent   = 'Save Task';
  document.getElementById('cancelBtn').classList.add('hidden');
  hideError('taskFormError');
}

// â”€â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteTask(id, title) {
  if (!confirm(`Delete task "${title}"?`)) return;
  try {
    const res = await fetch(`${API_BASE}/tasks/${id}/`, { method:'DELETE', headers:authHeaders() });
    if (!res.ok) throw new Error('Delete failed');
    // Remove from local array and DOM without full re-fetch
    allLoadedTasks = allLoadedTasks.filter(t => t.id !== id);
    const cards = document.querySelectorAll('#taskList > div');
    cards.forEach(card => {
      if (card.querySelector(`button[onclick*="deleteTask(${id},"]`)) card.remove();
    });
    updateStats();
    if (allLoadedTasks.length === 0) document.getElementById('emptyState').classList.remove('hidden');
  } catch { alert('Could not delete task. Please try again.'); }
}

// â”€â”€â”€ INFINITE SCROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sentinel = document.getElementById('scrollSentinel');
const observer = new IntersectionObserver((entries) => {
  if (entries[0].isIntersecting && nextCursor && !isFetching) {
    fetchNextPage();
  }
}, { rootMargin: '200px' });
observer.observe(sentinel);

// â”€â”€â”€ DEBOUNCED SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let debounceTimer;
function debouncedFetch() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(resetAndFetch, 500); // 500ms debounce for search
}

// â”€â”€â”€ CLOSE MODAL ON BACKDROP CLICK â”€â”€â”€â”€â”€â”€â”€
document.getElementById('detailModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (accessToken && currentUser) showDashboard();
</script>
</body>
</html>
